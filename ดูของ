--เซอร์วิท

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ContentProvider = game:GetService("ContentProvider")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local ItemESP_Enabled = true
local BillboardCache = {}
local ItemESP_UpdateConnections = {}
local WeaponDB = {}
local PreloadedImages = {}
local RainbowStrokes = {}

-- =====================================
-- RARITY COLORS
-- =====================================
local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(200, 200, 200),
    ["Uncommon"] = Color3.fromRGB(86, 176, 62),
    ["Rare"] = Color3.fromRGB(0, 162, 255),
    ["Epic"] = Color3.fromRGB(170, 85, 255),
    ["Legendary"] = Color3.fromRGB(255, 170, 0),
    ["Omega"] = Color3.fromRGB(255, 75, 75)
}

-- =====================================
-- GENERATE UNIQUE KEY
-- =====================================
local function generateUniqueKey(tool)
    if not tool or not tool:IsA("Tool") then return nil end
    local itemId = tool:GetAttribute("ItemId") or tool:GetAttribute("Id")
    if itemId and itemId ~= "" then return "ITEMID_" .. tostring(itemId) end
    return tool.Name
end
local function registerItems(folder)
    for _, tool in ipairs(folder:GetDescendants()) do
        if not tool:IsA("Tool") then continue end
        local key = generateUniqueKey(tool)
        if not key then continue end

        local imageId = tool:GetAttribute("ImageId") or ""
        local rarity = tool:GetAttribute("RarityName") or tool:GetAttribute("Rarity") or "Common"

        WeaponDB[key] = {
            Name = tool.Name,
            Rarity = rarity,
            ImageId = imageId,
            Tool = tool
        }

        if imageId:match("^rbxassetid://%d+$") and not PreloadedImages[imageId] then
            PreloadedImages[imageId] = true
            task.spawn(function()
                pcall(function()
                    ContentProvider:PreloadAsync({imageId})
                end)
            end)
        end
    end
end

pcall(function()
    registerItems(ReplicatedStorage)
    registerItems(game:GetService("StarterPack"))
end)
local function getWeaponInfo(tool)
    if not tool or not tool:IsA("Tool") then return nil end
    local key = generateUniqueKey(tool)
    return WeaponDB[key]
end
RunService.RenderStepped:Connect(function()
    local time = tick() % 10
    local offset = time / 10
    for i, stroke in ipairs(RainbowStrokes) do
        local hue = (i/#RainbowStrokes + offset) % 1
        stroke.Color = Color3.fromHSV(hue, 1, 1)
    end
end)

local function createBillboardForPlayer(player)
    if player == LocalPlayer or BillboardCache[player] then return end

    local billboard, container
    local connections = {}

    local function updateESP()
        if not ItemESP_Enabled or not billboard or not billboard.Parent then return end
        container:ClearAllChildren()

        local toolsList = {}

        local function scan(folder)
            if not folder then return end
            for _, tool in ipairs(folder:GetChildren()) do
                if tool:IsA("Tool") then
                    local info = getWeaponInfo(tool)
                    if info and info.ImageId:match("^rbxassetid://%d+$") then
                        table.insert(toolsList, info)
                    end
                end
            end
        end

        if player.Character then scan(player.Character) end
        for _, folderName in ipairs({"Backpack","StarterGear","StarterPack"}) do
            local folder = player:FindFirstChild(folderName)
            if folder then scan(folder) end
        end

        for i, info in ipairs(toolsList) do
            local bg = Instance.new("Frame")
            bg.Size = UDim2.new(0,35,0,35)
            bg.BackgroundColor3 = RARITY_COLORS[info.Rarity] or Color3.fromRGB(200,200,200)
            bg.BackgroundTransparency = 0
            bg.Parent = container

            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0,6)
            corner.Parent = bg

            local stroke = Instance.new("UIStroke")
            stroke.Thickness = 2
            stroke.Parent = bg
            table.insert(RainbowStrokes, stroke)

            local img = Instance.new("ImageLabel")
            img.Size = UDim2.new(1,-6,1,-6)
            img.Position = UDim2.new(0,3,0,3)
            img.BackgroundTransparency = 1
            img.Image = info.ImageId
            img.ScaleType = Enum.ScaleType.Fit
            img.Parent = bg
        end
    end

    local function setupBillboard()
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        if BillboardCache[player] then BillboardCache[player]:Destroy() end
        for _, conn in pairs(connections) do if conn.Connected then conn:Disconnect() end end
        connections = {}

        billboard = Instance.new("BillboardGui")
        billboard.Name = "ItemESP"
        billboard.Adornee = hrp
        billboard.Size = UDim2.new(0,280,0,40)
        billboard.StudsOffset = Vector3.new(0,-6.5,0)
        billboard.AlwaysOnTop = true
        billboard.LightInfluence = 0
        billboard.Parent = hrp

        container = Instance.new("Frame")
        container.Size = UDim2.new(1,0,1,0)
        container.BackgroundTransparency = 1
        container.Parent = billboard

        BillboardCache[player] = billboard
        updateESP()

        for _, folderName in ipairs({"Backpack","StarterGear","StarterPack"}) do
            local folder = player:FindFirstChild(folderName)
            if folder then
                table.insert(connections, folder.ChildAdded:Connect(updateESP))
                table.insert(connections, folder.ChildRemoved:Connect(updateESP))
            end
        end

        if char then
            table.insert(connections, char.ChildAdded:Connect(function(child)
                if child:IsA("Tool") then task.defer(updateESP) end
            end))
            table.insert(connections, char.ChildRemoved:Connect(function(child)
                if child:IsA("Tool") then task.defer(updateESP) end
            end))
        end
    end

    if player.Character then task.spawn(setupBillboard) end
    table.insert(connections, player.CharacterAdded:Connect(function() task.wait(1); setupBillboard() end))
    ItemESP_UpdateConnections[player] = connections
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then createBillboardForPlayer(p) end
end
Players.PlayerAdded:Connect(function(p)
    if p ~= LocalPlayer then createBillboardForPlayer(p) end
end)
Players.PlayerRemoving:Connect(function(p)
    if BillboardCache[p] then BillboardCache[p]:Destroy(); BillboardCache[p]=nil end
    if ItemESP_UpdateConnections[p] then
        for _, conn in pairs(ItemESP_UpdateConnections[p]) do if conn.Connected then conn:Disconnect() end end
        ItemESP_UpdateConnections[p] = nil
    end
end)
print("ดูของ to 2777 one")
